# XRISM Resolve Detect Pseudo Events and Clustering Tool

## Overview

`resolve_ftools_detect_pseudo_event_clusters.py` is a Python-based tool designed to **identify and annotate pseudo events** in X-ray event data from XRISMâ€™s **Resolve** instrument.

> **Naming note**  
> `resolve_ftools_add_cluster.py` is the **legacy name** of this tool. The current maintained implementation is
> `resolve_ftools_detect_pseudo_event_clusters.py`.

Pseudo events are detector triggers that are **not caused by astrophysical X-ray photons**, but instead originate from **cosmic-ray interactions, electronics response, waveform subtraction artifacts, or algorithmic edge cases**. While Resolve already flags known cross-talk events, this tool extends the capability to identify **time-correlated event structures** that are inconsistent with independent astrophysical photons.

The clustering algorithm operates **per pixel**, grouping events that occur within short temporal windows and annotating them with cluster metadata. The output FITS file preserves all original rows and columns, while adding cluster-related diagnostic columns that allow downstream screening, grade studies, and exposure evaluation.

This script is typically used as part of the shell pipeline:

```bash
./run_cluster_pipeline.sh <input_file_uf.evt>
````

Please read **before running**:

* `README_cluster_pipeline.md`

---

## Repository location (current script)

* `resolve_ftools_detect_pseudo_event_clusters.py`
  [https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_detect_pseudo_event_clusters.py](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_detect_pseudo_event_clusters.py)

---

## Dependencies

* Python 3.x
* NumPy
* Astropy
* Matplotlib (optional, for diagnostics)

No proprietary XRISM software is required. The tool operates on standard FITS event files.

---

## Usage

### Recommended usage (pipeline)

```bash
./run_cluster_pipeline.sh <input_file_uf.evt>
```

Within the pipeline, `resolve_ftools_detect_pseudo_event_clusters.py` is invoked sequentially in
**large** and **small** clustering modes (see the pipeline README for file naming details).

### Direct invocation example

```bash
resolve_ftools_detect_pseudo_event_clusters.py clean.evt \
  --mode small \
  --col_cluster ICLUSTERS \
  --col_member IMEMBERS \
  --outname small_ \
  -d
```

---

## Arguments (summary)

### Required

* `input_fits`
  Input FITS event file (EVENTS table in HDU=1).
  The file must already contain `PREV_INTERVAL` and `NEXT_INTERVAL` columns generated by
  `resolve_ftools_add_prevnext.sh`.

### Core options

* `--mode {large,small}`
  Clustering mode:

  * **large**: anchor on **large-amplitude Lp** triggers to detect particle-like clusters
  * **small**: detect **subtle pseudo events** consistent with waveform subtraction residuals and special forced-trigger populations (e.g., `NEXT_INTERVAL == 75` or `105`)

* `--usepixels` / `-p`
  Comma-separated pixel list (default: 0\UTF{2013}35)

### Output column names

* `--col_cluster` (default: `ICLUSTER`)
* `--col_member`  (default: `IMEMBER`)
* `--col_mode`    (default: `CL_MODE`)
* `--col_reason`  (default: `CL_REASON`)

### Diagnostics

* `-d / --debug`
  Verbose debug output
* `--figdir`
  Directory for diagnostic plots (default: `fig_cluster`)
* `--show`
  Show plots interactively (optional)

### Tunable parameters (defaults are encoded in the script)

* `--threshold_large` (default: 12235)
* `--interval_limit` (default: 40)
* `--SECOND_THRES_USE_LEN` (default: 75)
* `--rt_min` (default: 32)
* `--rt_max` (default: 58)
* `--mjdref` (default: 58484)

---

## Clustering Modes: Large vs Small

### Large mode

Designed to detect **macroscopic particle-induced events**, where a large pulse is a reliable indicator of a non-astrophysical trigger.

**Start condition (conceptual)**

* `ITYPE == Lp` and `LO_RES_PH > threshold_large`

Interpretation:

> Clusters anchored by a large-amplitude Lp are **unlikely to be astrophysical** and should be treated as suspect.

### Small mode

Optimized for detecting **subtle pseudo events**, including waveform subtraction residual triggers and special forced-trigger populations.

**Start condition (conceptual)**

* `ITYPE == Lp`, `LO_RES_PH <= threshold_large`
* and either:

  * short `NEXT_INTERVAL` (< `interval_limit`), or
  * special `NEXT_INTERVAL == 75`, or
  * special `NEXT_INTERVAL == 105`
* and rise-time anomaly (outside [`rt_min`, `rt_max`])

This mode is essential for understanding **Ls contamination**, which can be invisible to standard screening.

---

## Output

The output FITS file contains additional columns in the EVENTS extension.
No events are removed automatically.

### Primary annotation columns

* `ICLUSTER` (or `--col_cluster`)
  **Cluster ID** (`0` means not clustered).
  In the current implementation, `ICLUSTER` is defined as the **start-row index within the pixel stream**.
  All rows belonging to the same cluster share the same non-zero ID.

* `IMEMBER` (or `--col_member`)
  **Member index** within the cluster (`1..N`).
  `0` means not clustered.

* `CL_MODE` (or `--col_mode`)
  Mode code applied in the current run:
  `0` none, `1` large, `2` small.

* `CL_REASON` (or `--col_reason`)
  Bitmask encoding which conditions were satisfied and whether the row was used as:

  * a **cluster START** (START_OK), or
  * a **cluster CONTINUATION** (CONT_OK)

### Additional debug columns

* `PREV_LO_RES_PH`
* `PREV_ITYPE`

These are included to support local-context debugging and quick validation.

---

## Notes and Limitations

* This tool **annotates**; it does not reject events.
* Extremely high-rate conditions may break algorithmic assumptions (isolated-pulse premise).
* Some pseudo events may survive if their parent event is lost due to saturation or CPU drop.

---

# 7. Taxonomy of Pseudo Ls Events (Critical Section)

This section describes **five distinct classes of pseudo Ls events** that appear as Ls in Resolve data but are **not astrophysical X-ray photons**.

These categories are based on **timing structure, waveform behavior, and algorithmic response**, and are critical for **correct exposure and grade interpretation**.

---

## (1) Cosmic-ray\UTF{2013}induced pseudo Ls following a large pulse

**Description**
Pseudo Ls events generated immediately after a **very large pulse**, typically caused by a cosmic-ray interaction.

**Key signatures**

* Very short `NEXT_INTERVAL` (typically \UTF{2248} 25 samples)
* Often appears as a **single Lp + Ls pair**
* In some pixels, **one Lp followed by multiple Ls** may occur

**Physical origin**

* Occurs not only for fully clipped pulses, but also for **semi-clipped large-amplitude waveforms**
* Residuals from imperfect waveform subtraction satisfy the Ls trigger condition shortly after the primary event

**Interpretation**

> Cosmic-ray\UTF{2013}induced clipped or semi-clipped events producing artificial secondary triggers

---

## (2) Frame-event\UTF{2013}induced small-amplitude pseudo Ls

**Description**
Pseudo Ls events induced by **charged-particle hits on the readout board or frame**, rather than the absorber.

**Key signatures**

* Small waveform amplitude
* Very short effective time constant
* Typically appears as a **single Lp + Ls pair**

**Physical origin**

* Residual mismatch between the actual waveform and the subtraction template
* Residual crosses the Ls trigger threshold despite small absolute amplitude

**Operational impact**

> Often appears harmless, but **degrades event grading and effective exposure**

---

## (3) High-rate\UTF{2013}induced abnormal Lp/Ls (waveform subtraction breakdown)

**Description**
Occurs under **high event-rate conditions**, independent of cosmic-ray hits.

**Key signatures**

* Primary waveform subtraction becomes unstable
* Irregular increase of apparent Lp/Ls events
* Temporal patterns become non-Poissonian

**Physical origin**

* Breakdown of the algorithmic assumption of **isolated pulses**
* Errors in average waveform subtraction accumulate

**Interpretation**

> Purely algorithmic limitation, not a detector or physics issue

---

## (4) Pseudo Lp/Ls with NEXT_INTERVAL == 75

**Description**
A population of events clustered at **exactly 75 samples** in `NEXT_INTERVAL`.

**Key signatures**

* Waveforms are not obviously clipped
* Appear similar to nominal events
* Small but systematic residuals remain after subtraction

**Mechanism**

* Residual amplitude is too small to exceed `deriv_max / SECOND_THRES_FRAC`
* Trigger does not fire immediately
* Forced trigger occurs after `SECOND_THRES_USE_LEN = 75` samples

**Interpretation**

> Pseudo events generated by subtle but systematic deviations from the average waveform

---

## (5) Pseudo Lp/Ls with NEXT_INTERVAL == 105 (large amplitude, fast decay)

**Description**
Anomalous events concentrated at **NEXT_INTERVAL == 105**.

**Key signatures**

* Only appears for large-amplitude waveforms
* Rise time \UTF{2248} 25\UTF{2013}26 samples
* Effectively **abnormally fast decay in the derivative waveform**
* `slope_differ == 1`

**Physical origin**

* Large deviation from the average derivative waveform
* Produces large residuals that satisfy secondary trigger logic

**Interpretation**

> Special combination of large amplitude and non-standard decay behavior

---

# 8. Why Understanding Pseudo Ls Is Critical

Pseudo Ls events are particularly dangerous because:

* They are **numerous enough to matter**
* Some look **entirely plausible as real events**
* Even if removed later, they **leave irreversible grade degradation**

Most importantly:

> **Ignoring the pseudo origin of Ls events leads to systematic errors in evaluating the true astrophysical effective exposure.**

This affects:

* Exposure time estimates
* Grade distributions
* Spectral normalization
* High-rate observations and background modeling

For any analysis that relies on **Ls statistics**, pseudo-event taxonomy is **not optional**.

---

## Final remark

This tool provides **diagnostic transparency**, not automatic decisions.
Correct scientific conclusions require **physical interpretation of clustered Ls**, not blind filtering.

---

## Appendix
