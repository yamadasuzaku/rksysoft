# README: Clustering Pipeline Script

This script automates a three-step process to identify and analyze pseudo event clusters in a given `.evt` file.

## Script Name

```bash
resolve_ftools_cluster_pileline.sh
```

- [resolve_ftools_cluster_pileline.sh](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_cluster_pileline.sh)

## Usage

Usage of [resolve_ftools_cluster_pileline.sh](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_cluster_pileline.sh). 

```bash
./run_cluster_pipeline.sh <input_file_uf.evt>
```

* `<input_file_uf.evt>`: The input event file with `_uf.evt` suffix.

## Overview of Steps

1. **Add Prev/Next Interval Columns**

   * Calls [resolve_ftools_add_prevnext.sh](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_add_prevnext.sh) to append `PREV_INTERVAL` and `NEXT_INTERVAL` columns to the input FITS file.

2. **Run Cluster Detection**

   * Executes [resolve_ftools_add_cluster.py](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_add_cluster.py) twice:

     * First in `large` mode, to detect clusters caused by large signals (e.g., cosmic rays).
     * Then in `small` mode, to detect clusters caused by small/slow signals.

    * Please read "README_add_cluster.md" for more details located at 
    [XRISM Resolve Pseudo-Event Clustering Tool](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/README_add_cluster.md)

3. **Run Diagnostic Check**

   * Uses [resolve_ftools_qlcheck_cluster.py](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_qlcheck_cluster.py) to verify and visualize the clustering results.

---

## Output Files

The script generates intermediate and final files by appending prefixes and suffixes to the input filename:

| Stage        | Output File Example                                  |
| ------------ | ---------------------------------------------------- |
| After Step 1 | `xa000000000_noBL_prevnext_cutclgti.evt`             |
| After Step 2 | `large_xa000000000_noBL_prevnext_cutclgti.evt`       |
| After Step 2 | `small_large_xa000000000_noBL_prevnext_cutclgti.evt` |
| Final Check  | Diagnostic plots and logs generated by the QL tool   |

---

## Requirements

The script depends on the following tools being available in the system `PATH`:

* [`resolve_ftools_add_prevnext.sh`](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_add_prevnext.sh)
* [`resolve_ftools_add_cluster.py`](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_add_cluster.py)
* [`resolve_ftools_qlcheck_cluster.py`](https://github.com/yamadasuzaku/rksysoft/blob/main/resolve/ftools/rslcluster/resolve_ftools_qlcheck_cluster.py)

These tools are assumed to be part of the `rslcluster` or similar analysis package.

## Notes

* The script will stop immediately if any required file is missing.
* Temporary output files are overwritten without confirmation.
* It is recommended to run this script in a clean directory to avoid file conflicts.

---
